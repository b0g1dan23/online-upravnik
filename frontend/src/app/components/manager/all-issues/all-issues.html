<section class="grid gap-2">
    <h2>Pregled svih prijavljenih kvarova</h2>

    @if(issues$ | async; as issues) {
    @if(issues.length > 0) {
    <div class="grid grid-cols-3 gap-4 max-lg:grid-cols-2 max-md:grid-cols-1">
        @for (issue of issues; track $index) {
        <app-single-issue [issue]="issue" [canLoadDetails]="true"
            (showIssueDetails)="showIssueDetails(issue.id)"></app-single-issue>
        }
    </div>

    <div #scrollTrigger></div>

    @if(loadingMoreIssues$ | async) {
    <div class="flex justify-center items-center py-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <span class="ml-2">Učitava se još kvarova...</span>
    </div>
    }
    @else if(hasMorePages$ | async){
    <app-button class="table" (click)="loadMoreIssues()">
        Ucitaj još kvarova
    </app-button>
    }
    }@else {
    <p>Nema prijavljenih kvarova.</p>
    }
    }@else {
    <p>Došlo je do greške prilikom učitavanja prijavljenih kvarova.</p>
    }
</section>

@if(showModal | async) {
@if(selectedIssue$ | async; as issue) {
<app-modal (closed)="toggleModal()">
    <h2>Detalji prijavljenog kvara</h2>
    <p>Opis problema: {{ issue.problemDescription }}</p>
    <hr class="!my-2">
    <p>Prijavio je korisnik: {{issue.user.firstName + " " + issue.user.lastName}}</p>
    <p>Kontakt email korisnika: <a [href]="'mailto:' + issue.user.email">{{issue.user.email}}</a></p>
    <p>Broj telefona korisnika: <a [href]="'tel:' + issue.user.phoneNumber">{{issue.user.phoneNumber}}</a></p>
    <hr class="!my-2">
    <p>Adresa zgrade: {{issue.building.address}}</p>
    <hr class="!my-2">
    <p>Zaposleni odgovoran za zgradu: {{issue.employeeResponsible.firstName + " " + issue.employeeResponsible.lastName}}
    </p>
    <p>Kontakt email zaposlenog: <a
            [href]="'mailto:' + issue.employeeResponsible.email">{{issue.employeeResponsible.email}}</a>
    </p>
    <p>Kontakt telefon zaposlenog: <a
            [href]="'tel:' + issue.employeeResponsible.phoneNumber">{{issue.employeeResponsible.phoneNumber}}</a>
    </p>
    <p>Pozicija zaposlenog: {{issue.employeeResponsible.position}}</p>
    <hr class="!my-2">
    <p class="font-semibold text-gray-800 !mb-3">Svi statusi kvara:</p>
    @for (status of issue.statusHistory; track $index) {
    <div class="border-l-4 !p-3 rounded-r-lg !mb-3 shadow-sm" [ngClass]="{
       'border-green-500 bg-green-50': status.status === 'REŠENO',
       'border-blue-500 bg-blue-50': status.status === 'U_TOKU', 
       'border-red-500 bg-red-50': status.status === 'OTKAZANO',
       'border-gray-500 bg-gray-50': status.status === 'PRIJAVLJENO'
     }">
        <div class="flex items-center justify-between !mb-2">
            <span class="inline-block !px-3 !py-1 rounded-full text-sm font-medium" [ngClass]="{
                'bg-green-100 text-green-800': status.status === 'REŠENO',
                'bg-blue-100 text-blue-800': status.status === 'U_TOKU',
                'bg-red-100 text-red-800': status.status === 'OTKAZANO',
                'bg-gray-100 text-gray-800': status.status === 'PRIJAVLJENO'
              }">
                {{ status.status }}
            </span>
            <span class="text-sm text-gray-600 font-medium">
                {{ status.createdAt | date:'dd.MM.yyyy. HH:mm' }}
            </span>
        </div>
    </div>

    }
</app-modal>
}
}